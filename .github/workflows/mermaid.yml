name: Render Mermaid Diagrams

on:
    push:
        branches: ['main']
    workflow_dispatch:

jobs:
    render-mermaid:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repo
              uses: actions/checkout@v3

            - name: Install Mermaid CLI
              run: npm install -g @mermaid-js/mermaid-cli

            - name: Extract, render, and inject diagrams
              run: |
                  mkdir -p diagrams
                  count=0
                  inside=0
                  rm -f temp-*.mmd new_README.md

                  while IFS= read -r line; do
                    if [[ "$line" == '```mermaid' ]]; then
                      inside=1
                      count=$((count+1))
                      file="temp-$count.mmd"
                      echo "%% Auto-extracted from README - Diagram $count" > "$file"
                      echo "$line" >> new_README.md
                      continue
                    fi

                    if [[ "$line" == '```' && $inside -eq 1 ]]; then
                      inside=0
                      echo "$line" >> new_README.md
                      mmdc -i "$file" -o "diagrams/diagram-$count.svg"
                      echo "" >> new_README.md
                      echo "![Diagram $count](diagrams/diagram-$count.svg)" >> new_README.md
                      echo "" >> new_README.md
                      continue
                    fi

                    if [[ $inside -eq 1 ]]; then
                      echo "$line" >> "$file"
                      echo "$line" >> new_README.md
                    else
                      echo "$line" >> new_README.md
                    fi
                  done < README.md

                  mv new_README.md README.md

            - name: Commit updated diagrams and README
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"
                  git add diagrams/*.svg README.md
                  git commit -m "Auto-generate Mermaid diagrams and inject into README" || echo "No changes to commit"
                  git push
